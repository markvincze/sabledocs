version: 2.1

orbs:
  python: circleci/python@1.5.0

jobs:
  build_dev:
    docker:
      - image: cimg/python:3.11.3
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          app-dir: ~/project/src/sabledocs/
          # export PACKAGE_VERSION="$package_base_version.${CIRCLE_BUILD_NUM}dev0"
          # echo "export PACKAGE_VERSION='$package_base_version.${CIRCLE_BUILD_NUM}dev0'" >> $BASH_ENV
      - run:
          command: |
            pip install build
            python -m build -C--global-option=egg_info -C--global-option=--tag-build=".${CIRCLE_BUILD_NUM}dev"
            echo "Determining package version"
            package_base_version=$(grep 'version =' pyproject.toml | sed -e 's/version = "\(.*\)"/\1/')
            echo "Package version: ${package_base_version}"
            echo "export PACKAGE_VERSION='$package_base_version.${CIRCLE_BUILD_NUM}.dev0'"
            echo "export PACKAGE_VERSION='$package_base_version.${CIRCLE_BUILD_NUM}.dev0'" >> $BASH_ENV
            echo "BASH_ENV: ${BASH_ENV}"
            cp $BASH_ENV bash.env
      - persist_to_workspace:
          root: .
          paths:
            - "dist/*"
            - "bash.env"

  build_stable:
    docker:
      - image: cimg/python:3.11.3
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
          app-dir: ~/project/src/sabledocs/
      - run:
          command: |
            pip install build
            python -m build -C--global-option=egg_info -C--global-option=--tag-build=".${CIRCLE_BUILD_NUM}"
            package_base_version=$(grep 'version =' pyproject.toml | sed -e 's/version = "\(.*\)"/\1/')
            echo "export PACKAGE_VERSION='$package_base_version.${CIRCLE_BUILD_NUM}'" >> $BASH_ENV
            printenv PACKAGE_VERSION
            cp $BASH_ENV bash.env
      - persist_to_workspace:
          root: .
          paths:
            - "dist/*"
            - "bash.env"

  publish_pypi:
    docker:
      - image: cimg/python:3.11.3
    steps:
      - attach_workspace:
          at: .
      - run:
          command: |
            pip install twine
            python -m twine upload -u __token__ -p ${PYPI_API_TOKEN} ~/project/dist/*

  generate_sample_docs:
    docker:
      - image: cimg/python:3.11.3
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "d5:12:33:42:6b:cd:57:b7:7f:08:2c:7a:a2:c4:54:6d"
      - python/install-packages:
          pkg-manager: pip
          app-dir: ~/project/src/sabledocs/
      - run:
          command: |
            git config --global user.email "mrk.vincze@gmail.com"
            git config --global user.name "sabledocs CI"
            chmod +x generate_sample_docs.sh
            ./generate_sample_docs.sh

  publish_docker_image:
    docker:
      - image: cimg/python:3.11.3
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          version: 20.10.14
      - run:
          name: Restore environment variables
          command: |
            cat bash.env
            echo $BASH_ENV
            cat bash.env >> $BASH_ENV
      - run:
          name: Build and publish Docker image
          command: |
            printenv PACKAGE_VERSION
            protoc_version=$(curl -sL https://api.github.com/repos/protocolbuffers/protobuf/releases/latest | jq -r ".tag_name")
            echo "docker build -t markvincze/sabledocs:${PACKAGE_VERSION} --build-arg sabledocs_version=${PACKAGE_VERSION} --build-arg protoc_version=${protoc_version:1} ."
            image_tag=markvincze/sabledocs:${PACKAGE_VERSION}
            docker build -t ${image_tag} --build-arg sabledocs_version=${PACKAGE_VERSION} --build-arg protoc_version=${protoc_version:1} .
            echo "${DOCKERHUB_ACCESS_TOKEN}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin
            docker push "${image_tag}"

workflows:
  build-and-publish:
    jobs:
      - build_dev:
          filters:
            branches:
              ignore:
                - main
      - build_stable:
          filters:
            branches:
              only:
                - main
      - publish_pypi:
          name: publish_pypi_dev
          requires:
            - build_dev
      - publish_pypi:
          name: publish_pypi_stable
          requires:
            - build_stable
      - generate_sample_docs:
          requires:
            - publish_pypi_stable
      - publish_docker_image:
          name: publish_docker_image_dev
          requires:
            - publish_pypi_dev
      - publish_docker_image:
          name: publish_docker_image_stable
          requires:
            - publish_pypi_stable
